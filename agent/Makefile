# Makefile for cross-platform RMM Agent compilation
# æ”¯æŒ Windows, Linux, macOS ç›®æ ‡å¹³å°

.PHONY: all clean install-deps build-all build-windows build-linux build-macos test package help

# é»˜è®¤ç›®æ ‡
all: build-all

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "RMM Agent è·¨å¹³å°ç¼–è¯‘ Makefile"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  all           - ç¼–è¯‘æ‰€æœ‰æ”¯æŒçš„å¹³å°"
	@echo "  build-all     - ç¼–è¯‘æ‰€æœ‰å¹³å°"
	@echo "  build-windows - ç¼–è¯‘ Windows ç‰ˆæœ¬"
	@echo "  build-linux   - ç¼–è¯‘ Linux ç‰ˆæœ¬"
	@echo "  build-macos   - ç¼–è¯‘ macOS ç‰ˆæœ¬"
	@echo "  install-deps  - å®‰è£…ç¼–è¯‘ä¾èµ–"
	@echo "  test          - è¿è¡Œæµ‹è¯•"
	@echo "  package       - æ‰“åŒ…æ‰€æœ‰å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶"
	@echo "  clean         - æ¸…ç†ç¼–è¯‘äº§ç‰©"
	@echo "  help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

# å®‰è£…ç¼–è¯‘ä¾èµ–
install-deps:
	@echo "å®‰è£…è·¨å¹³å°ç¼–è¯‘ä¾èµ–..."
	rustup target add x86_64-pc-windows-gnu
	rustup target add x86_64-pc-windows-msvc
	rustup target add x86_64-unknown-linux-musl
	rustup target add x86_64-unknown-linux-gnu
	rustup target add aarch64-unknown-linux-musl
	rustup target add aarch64-unknown-linux-gnu
ifeq ($(shell uname -s),Darwin)
	rustup target add x86_64-apple-darwin
	rustup target add aarch64-apple-darwin
endif
	@if ! command -v cross >/dev/null 2>&1; then \
		echo "å®‰è£… cross å·¥å…·..."; \
		cargo install cross --git https://github.com/cross-rs/cross; \
	fi

# ç¼–è¯‘æ‰€æœ‰å¹³å°
build-all: build-windows build-linux build-macos

# Windows ç¼–è¯‘
build-windows:
	@echo "ç¼–è¯‘ Windows ç‰ˆæœ¬..."
	@mkdir -p target/release-windows
	cargo build --release --target x86_64-pc-windows-msvc --features "windows,tls-strict"
	@if [ -f target/x86_64-pc-windows-msvc/release/rmm-agent.exe ]; then \
		cp target/x86_64-pc-windows-msvc/release/rmm-agent.exe target/release-windows/rmm-agent-windows-x64.exe; \
		echo "âœ… Windows x64 ç¼–è¯‘å®Œæˆ"; \
	fi
	
	cargo build --release --target x86_64-pc-windows-gnu --features "windows,tls-strict"
	@if [ -f target/x86_64-pc-windows-gnu/release/rmm-agent.exe ]; then \
		cp target/x86_64-pc-windows-gnu/release/rmm-agent.exe target/release-windows/rmm-agent-windows-x64-gnu.exe; \
		echo "âœ… Windows x64 GNU ç¼–è¯‘å®Œæˆ"; \
	fi

# Linux ç¼–è¯‘
build-linux:
	@echo "ç¼–è¯‘ Linux ç‰ˆæœ¬..."
	@mkdir -p target/release-linux
	cross build --release --target x86_64-unknown-linux-musl --features "linux,tls-strict,doh,static-link"
	@if [ -f target/x86_64-unknown-linux-musl/release/rmm-agent ]; then \
		cp target/x86_64-unknown-linux-musl/release/rmm-agent target/release-linux/rmm-agent-linux-x64-static; \
		echo "âœ… Linux x64 é™æ€é“¾æ¥ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"; \
	fi
	
	cross build --release --target x86_64-unknown-linux-gnu --features "linux,tls-strict,doh"
	@if [ -f target/x86_64-unknown-linux-gnu/release/rmm-agent ]; then \
		cp target/x86_64-unknown-linux-gnu/release/rmm-agent target/release-linux/rmm-agent-linux-x64; \
		echo "âœ… Linux x64 åŠ¨æ€é“¾æ¥ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"; \
	fi
	
	cross build --release --target aarch64-unknown-linux-musl --features "linux,tls-strict,doh,static-link"
	@if [ -f target/aarch64-unknown-linux-musl/release/rmm-agent ]; then \
		cp target/aarch64-unknown-linux-musl/release/rmm-agent target/release-linux/rmm-agent-linux-arm64-static; \
		echo "âœ… Linux ARM64 é™æ€é“¾æ¥ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"; \
	fi

# macOS ç¼–è¯‘ (ä»…åœ¨ macOS ä¸Šå¯ç”¨)
build-macos:
ifeq ($(shell uname -s),Darwin)
	@echo "ç¼–è¯‘ macOS ç‰ˆæœ¬..."
	@mkdir -p target/release-macos
	cargo build --release --target x86_64-apple-darwin --features "macos,tls-strict,doh"
	@if [ -f target/x86_64-apple-darwin/release/rmm-agent ]; then \
		cp target/x86_64-apple-darwin/release/rmm-agent target/release-macos/rmm-agent-macos-x64; \
		echo "âœ… macOS x64 ç¼–è¯‘å®Œæˆ"; \
	fi
	
	cargo build --release --target aarch64-apple-darwin --features "macos,tls-strict,doh"
	@if [ -f target/aarch64-apple-darwin/release/rmm-agent ]; then \
		cp target/aarch64-apple-darwin/release/rmm-agent target/release-macos/rmm-agent-macos-arm64; \
		echo "âœ… macOS ARM64 ç¼–è¯‘å®Œæˆ"; \
	fi
else
	@echo "âš ï¸  macOS ç¼–è¯‘ä»…åœ¨ macOS ç³»ç»Ÿä¸Šæ”¯æŒ"
endif

# è¿è¡Œæµ‹è¯•
test:
	@echo "è¿è¡Œè·¨å¹³å°æµ‹è¯•..."
	cargo test --features "test-local"
	cargo test --features "windows,test-local" --target x86_64-pc-windows-msvc || true
	cross test --features "linux,test-local" --target x86_64-unknown-linux-gnu || true

# æ‰“åŒ…æ‰€æœ‰å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
package: build-all
	@echo "æ‰“åŒ…æ‰€æœ‰å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶..."
	@mkdir -p dist
	
	# æ‰“åŒ… Windows ç‰ˆæœ¬
	@if [ -d target/release-windows ]; then \
		cd target/release-windows && tar -czf ../../dist/rmm-agent-windows.tar.gz *; \
		echo "ğŸ“¦ Windows ç‰ˆæœ¬å·²æ‰“åŒ…åˆ° dist/rmm-agent-windows.tar.gz"; \
	fi
	
	# æ‰“åŒ… Linux ç‰ˆæœ¬
	@if [ -d target/release-linux ]; then \
		cd target/release-linux && tar -czf ../../dist/rmm-agent-linux.tar.gz *; \
		echo "ğŸ“¦ Linux ç‰ˆæœ¬å·²æ‰“åŒ…åˆ° dist/rmm-agent-linux.tar.gz"; \
	fi
	
	# æ‰“åŒ… macOS ç‰ˆæœ¬
	@if [ -d target/release-macos ]; then \
		cd target/release-macos && tar -czf ../../dist/rmm-agent-macos.tar.gz *; \
		echo "ğŸ“¦ macOS ç‰ˆæœ¬å·²æ‰“åŒ…åˆ° dist/rmm-agent-macos.tar.gz"; \
	fi
	
	@echo "ğŸ‰ æ‰€æœ‰å¹³å°æ‰“åŒ…å®Œæˆï¼"

# æ¸…ç†ç¼–è¯‘äº§ç‰©
clean:
	@echo "æ¸…ç†ç¼–è¯‘äº§ç‰©..."
	cargo clean
	rm -rf target/release-*
	rm -rf dist
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
info:
	@echo "ç¼–è¯‘ç¯å¢ƒä¿¡æ¯:"
	@echo "Rust ç‰ˆæœ¬: $(shell rustc --version)"
	@echo "Cargo ç‰ˆæœ¬: $(shell cargo --version)"
	@echo "ç›®æ ‡å¹³å°: $(shell rustc --print target-list | grep -E '(windows|linux|darwin)' | head -10)"
	@echo "å·²å®‰è£…ç›®æ ‡: $(shell rustup target list --installed | grep -E '(windows|linux|darwin)')"